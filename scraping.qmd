---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r}
#| include: FALSE

library(tidyverse)
library(stringr)
library(purrr)
library(dplyr)
library(rvest)
library(httr)
library(spotifyr)
```


```{r}
Sys.setenv(SPOTIFY_CLIENT_ID = '8ee4ffc433b4478895fc9f4a34228065')
Sys.setenv(SPOTIFY_CLIENT_SECRET = '5a81b10ef1ea442fbae3e1c104271806')

access_token <- get_spotify_access_token()

```

```{r}
noah <- get_artist_audio_features('2RQXRUsr4IW1f3mKyKsy4B')
noah
```

```{r}
noahalbums <- get_artist('2RQXRUsr4IW1f3mKyKsy4B')
noahalbums
```


#get top most popular 10 genres on spotify
```{r}
#top 50 artists of each genre by number of followers
indie <- get_genre_artists("indie", limit = 50)
country <- get_genre_artists("country", limit = 50)
rock <- get_genre_artists("rock", limit = 50)
pop <- get_genre_artists("pop", limit = 50)
rap <- get_genre_artists("rap", limit = 50)
edm <- get_genre_artists("edm", limit = 50)
latin <- get_genre_artists("latin", limit = 50)
christian <- get_genre_artists("christian", limit = 50)
hip_hop <- get_genre_artists("hip-hop", limit = 50)
r_b <- get_genre_artists("R&B", limit = 50)

```

```{r}
#dataset with 394 rows all the genres, each artist shows up once (some were in multiple genres)
genres <- indie |>
  full_join(country) |>
  full_join(rock) |>
  full_join(pop) |>
  full_join(rap) |>
  full_join(edm) |>
  full_join(latin) |>
  full_join(christian) |>
  full_join(hip_hop) |>
  full_join(r_b) |>
  distinct(name, .keep_all = TRUE)
genres
```

```{r}
#top 3 artists for each genres based on popularity, there were some ties
#want to join artist song data to artists by id
artists <- genres |>
  group_by(genre) |>
  slice_max(popularity, n = 3) |>
  select(href, id, name, popularity, uri, followers.total, genre) 

audio_features <- data.frame()

temp <- c("3fMbdgg4jU18AjLCKBhRSm", "7FNnA9vBm6EKceENgCGRMb", "20wkVLutqVOYrc0kxFs7rA")

# go through each artist ID and get audio features
for (artist_id in artists$id) {
  artist_audio_features <- get_artist_audio_features(artist_id)
  audio_features <- bind_rows(audio_features, artist_audio_features)
}


print(audio_features)
```

```{r}
audio_features |>
  count(artist_name)
```

```{r}
artist_songs <- left_join(artists, audio_features, by = c("id" = "artist_id"))

#remove songs that appear multiple times, remove unnecessary columns
songs <- artist_songs |>
  distinct(track_name, .keep_all = TRUE) |>
  select(!c(href, album_type, album_images,    album_release_date_precision, analysis_url, track_href, track_preview_url, type, external_urls.spotify))

write_rds(songs, "songs.csv")
```

```{r}
read_rds("songs.csv")
```

